<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turbine Analytics Suite v3.0 (Flexible Date)</title>
    <!-- Load Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Dark Theme (Default) */
            --primary-color: #00e676;
            --primary-hover: #00c853;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.8);
            --tooltip-bg: rgba(15, 23, 42, 0.95);
            --panel-bg: rgba(15, 23, 42, 0.98);
            --shadow-color: rgba(0, 0, 0, 0.5);
            
            --transition-speed: 0.4s;
        }

        /* Light Theme Overrides */
        [data-theme="light"] {
            --primary-color: #00a152; /* Darker Green for light mode */
            --primary-hover: #008141;
            --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(0, 0, 0, 0.1);
            --text-main: #102a43;
            --text-muted: #486581;
            --card-bg: rgba(255, 255, 255, 0.9);
            --tooltip-bg: rgba(255, 255, 255, 0.98);
            --panel-bg: rgba(255, 255, 255, 0.98);
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            box-sizing: border-box;
            transition: background 0.5s ease, color 0.5s ease; /* Fade transition for theme */
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- THEME TOGGLE --- */
        .theme-toggle-wrapper {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 100;
        }

        .theme-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px var(--shadow-color);
        }

        .theme-btn:hover {
            transform: rotate(15deg) scale(1.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* --- HEADER --- */
        header {
            text-align: center;
            margin-bottom: 30px; 
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 200;
            margin: 0 0 10px 0;
            letter-spacing: -1px;
            /* Gradient Text Logic adapted for themes */
            background: linear-gradient(to right, var(--text-main), var(--text-muted));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: all var(--transition-speed);
        }

        p.subtitle {
            color: var(--text-muted);
            font-size: 1rem;
            margin: 0;
            transition: color var(--transition-speed);
        }

        /* --- INPUT SECTION --- */
        .input-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .date-format-selector {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }
        
        .date-format-selector:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto 30px auto;
        }

        @media (max-width: 768px) {
            .input-section { grid-template-columns: 1fr; }
        }

        .upload-area, .paste-area {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 12px; 
            padding: 20px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px var(--shadow-color);
        }

        /* Upload Zone */
        .upload-area {
            border: 2px dashed var(--glass-border);
            text-align: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            height: 150px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        .upload-area input[type=file] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .upload-icon {
            font-size: 2rem; 
            color: var(--text-muted);
            transition: color 0.3s;
        }

        .upload-area:hover .upload-icon {
            color: var(--primary-color);
        }

        /* Paste Zone */
        .paste-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 150px;
        }

        .paste-area textarea {
            flex-grow: 1;
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-main);
            padding: 8px;
            resize: none;
            font-family: monospace;
            font-size: 0.85rem;
            transition: background 0.3s, color 0.3s;
        }
        
        .paste-area textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .paste-btn {
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            text-align: center;
        }

        .paste-btn:hover {
            background: rgba(0,0,0,0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* --- CHART LAYOUT WITH SIDEBAR --- */
        .analytics-wrapper {
            display: flex;
            gap: 20px;
            position: relative;
            align-items: flex-start;
        }

        .chart-wrapper {
            flex-grow: 1;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px -5px var(--shadow-color);
            position: relative;
            min-height: 750px;
            transition: width 0.3s ease;
        }

        /* Floating Controls */
        .chart-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .control-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .control-btn.active-state {
            background: rgba(0, 230, 118, 0.15);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        #mainChart {
            width: 100%;
            height: 750px;
            border-radius: 8px;
        }

        /* --- FLOATING DATA INSPECTOR --- */
        .data-inspector {
            width: 320px;
            max-height: 80vh; 
            overflow: hidden;
            
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            
            position: absolute;
            top: 70px;
            right: 30px; 
            z-index: 60;
            
            box-shadow: 0 15px 40px var(--shadow-color);
            
            display: none; 
            flex-direction: column;
            
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .data-inspector.active {
            display: flex;
            opacity: 1;
        }

        .inspector-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.1);
            cursor: move; 
            user-select: none;
        }

        .inspector-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-main);
            font-weight: 600;
        }

        .inspector-time {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-top: 4px;
            display: block;
        }

        .close-inspector {
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
            font-size: 1.2rem;
            padding: 5px;
        }
        .close-inspector:hover { color: var(--text-main); }

        .inspector-body {
            padding: 10px 0;
            overflow-y: auto;
            flex-grow: 1;
        }

        .inspector-row {
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .inspector-row:hover {
            background: rgba(125,125,125,0.05);
        }

        .inspector-label {
            color: var(--text-muted);
            margin-right: 10px;
            word-break: break-word;
        }

        .inspector-value {
            color: var(--text-main);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .inspector-row::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--row-color, #ccc);
            margin-right: 10px;
            flex-shrink: 0;
        }

        /* --- TOOLTIP --- */
        #customTooltip {
            position: absolute;
            pointer-events: none; 
            background: var(--tooltip-bg);
            backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            border-radius: 8px; 
            padding: 12px;
            color: var(--text-main); 
            box-shadow: 0 10px 25px var(--shadow-color);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.1s ease;
            transform: translate(15px, 15px) scale(0.95);
            min-width: 150px;
        }

        #customTooltip.visible {
            opacity: 1;
            transform: translate(15px, 15px) scale(1);
        }

        .tooltip-header-simple {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .tooltip-value-simple {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 2px;
        }
        .tooltip-label-simple {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- LEGEND MODAL & CONTROLS --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: block;
            opacity: 1;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            margin: 5vh auto; 
            padding: 0;
            border-radius: 12px;
            width: 90%; 
            max-width: 800px;
            max-height: 85vh; 
            display: flex;
            flex-direction: column; 
            box-shadow: 0 25px 50px var(--shadow-color);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            overflow: hidden; 
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.1);
            flex-shrink: 0; 
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-modal { 
            cursor: pointer; 
            font-size: 1.2rem; 
            opacity: 0.7;
            padding: 5px;
            transition: opacity 0.2s;
        }
        .close-modal:hover { opacity: 1; }

        /* Compact Controls */
        .legend-controls {
            padding: 10px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            gap: 12px;
            background: rgba(0,0,0,0.05);
            flex-shrink: 0; 
        }

        .search-box {
            position: relative;
            flex-grow: 1; 
        }

        .search-box input {
            background: rgba(0,0,0,0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px 10px 8px 36px;
            border-radius: 6px;
            width: 100%; 
            box-sizing: border-box; 
            font-size: 0.9rem;
            transition: border 0.2s, background 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(125,125,125,0.15);
        }

        .legend-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* --- BUTTONS --- */
        .legend-action-btn {
            background-color: #1e293b;
            color: #f8fafc;
            border: 1px solid #334155;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .legend-action-btn:hover { background-color: #334155; border-color: #475569; transform: translateY(-1px); }
        .legend-action-btn:active { transform: translateY(0); }

        [data-theme="light"] .legend-action-btn { background-color: #f1f5f9; color: #1e293b; border-color: #cbd5e1; }
        [data-theme="light"] .legend-action-btn:hover { background-color: #e2e8f0; }


        .modal-body {
            flex-grow: 1;       
            overflow-y: auto;   
            min-height: 0;      
            position: relative;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 8px;
            padding: 15px 20px;
            align-items: start; /* Prevent stretch height */
        }

        /* --- LEGEND ITEM STRUCTURE --- */
        .legend-card {
            background: rgba(125,125,125,0.05);
            color: var(--text-main);
            border-radius: 6px;
            border: 1px solid transparent;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .legend-card:hover { 
            background: rgba(125,125,125,0.1); 
        }

        .legend-card-header {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            justify-content: space-between;
        }
        
        .legend-card-info {
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .legend-color-dot {
            width: 10px; height: 10px; 
            border-radius: 50%; 
            margin-right: 8px; 
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .legend-name {
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }

        .legend-settings-btn {
            color: var(--text-muted);
            opacity: 0.5;
            padding: 4px;
            transition: all 0.2s;
            margin-left: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .legend-settings-btn:hover {
            opacity: 1;
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
        }

        .legend-card.hidden-item .legend-name { opacity: 0.5; text-decoration: line-through; }
        .legend-card.hidden-item .legend-color-dot { background: #777 !important; }

        /* Settings Panel */
        .legend-settings-panel {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-top: 1px solid var(--glass-border);
            display: none;
            gap: 8px;
            flex-direction: column;
        }
        .legend-settings-panel.open { display: flex; }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .style-select {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 0.8rem;
            width: 90px;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            padding: 0;
            overflow: hidden;
            cursor: pointer;
            background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid var(--glass-border); border-radius: 50%; }


        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: transparent; }
        .modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* Loader */
        .loader {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            z-index: 20;
        }

        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .file-info {
            text-align: center;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s;
        }
        .file-info.visible { display: block; }
        .info-tag {
            background: rgba(0, 230, 118, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* --- LEGEND GROUPING --- */
        .legend-category-block {
            margin-bottom: 20px;
        }

        .legend-category-header {
            color: var(--primary-color);
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--glass-border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .legend-category-header i {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* --- SNAPSHOT NOTIFICATION --- */
        .snapshot-flash {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            transition: opacity 0.1s;
        }
        .snapshot-flash.active {
            opacity: 0.5;
        }

    </style>
</head>
<body data-theme="dark">

<div class="container">
    
    <!-- Theme Toggle -->
    <div class="theme-toggle-wrapper">
        <button class="theme-btn" id="themeToggle" title="Toggle Dark/Light Mode">
            <i class="fas fa-moon" id="themeIcon"></i>
        </button>
    </div>

    <header>
        <h1>Turbine Analytics Suite</h1>
        <p class="subtitle">Interactive Performance Visualization</p>
    </header>

    <!-- NEW: Date Format Selector -->
    <div class="input-controls">
        <select id="dateFormatSelect" class="date-format-selector">
            <option value="auto">ðŸ“… Auto-Detect Date Format</option>
            <option value="dmy">Day / Month / Year (e.g., 31/01/2024)</option>
            <option value="mdy">Month / Day / Year (e.g., 01/31/2024)</option>
            <option value="ymd">Year / Month / Day (e.g., 2024/01/31)</option>
        </select>
    </div>

    <!-- INPUT SECTION -->
    <div class="input-section">
        <div class="upload-area" id="dropZone">
            <input type="file" id="csvInput" accept=".csv">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <div class="upload-text">Upload CSV File</div>
            <div class="upload-subtext">Drag & drop or click</div>
        </div>
        <div class="paste-area">
            <textarea id="pasteInput" placeholder="Paste Excel/CSV data here..."></textarea>
            <button class="paste-btn" id="processPasteBtn">
                <i class="fas fa-bolt"></i> Visualize Data
            </button>
        </div>
    </div>

    <div class="file-info" id="fileInfo">
        <span class="info-tag"><i class="fas fa-check-circle"></i> <span id="fileName">Ready</span></span>
    </div>
    
    <!-- CHART + SIDEBAR CONTAINER -->
    <div class="analytics-wrapper">
        <div class="chart-wrapper">
            <div class="chart-controls">
                <button id="resetZoomBtn" class="control-btn"><i class="fas fa-compress"></i> Reset</button>
                <button id="snapshotBtn" class="control-btn"><i class="fas fa-camera"></i> Snapshot</button>
                <button id="openLegendBtn" class="control-btn"><i class="fas fa-layer-group"></i> Legend</button>
            </div>
            
            <div class="loader" id="loader"></div>
            <div id="mainChart"></div>
            <!-- Modified Simple Tooltip -->
            <div id="customTooltip"></div>
            <!-- Snapshot Flash Effect -->
            <div id="snapshotFlash" class="snapshot-flash"></div>
        </div>

        <!-- FLOATING DATA INSPECTOR -->
        <div id="dataInspector" class="data-inspector">
            <div class="inspector-header">
                <div>
                    <h3>Data Snapshot</h3>
                    <span id="inspectorTime" class="inspector-time">Select a point...</span>
                </div>
                <div class="close-inspector" id="closeInspector"><i class="fas fa-times"></i></div>
            </div>
            <div class="inspector-body" id="inspectorContent">
                <div style="padding:20px; text-align:center; color:var(--text-muted);">
                    Click on the chart to view full dataset details for that timestamp.
                </div>
            </div>
        </div>
    </div>

</div>

<!-- LEGEND MODAL -->
<div id="legendModal" class="modal">
    <div class="modal-content">
        <!-- Compact Header -->
        <div class="modal-header">
            <h2>Chart Layers</h2>
            <span class="close-modal"><i class="fas fa-times"></i></span>
        </div>
        <!-- Compact Controls -->
        <div class="legend-controls">
            <div class="search-box">
                <i class="fas fa-search" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text-muted); font-size: 0.8rem;"></i>
                <input type="text" id="legendSearch" placeholder="Search sensors...">
            </div>
            <div class="legend-actions">
                <button id="selectAllBtn" class="legend-action-btn">All</button>
                <button id="deselectAllBtn" class="legend-action-btn">None</button>
            </div>
        </div>
        <!-- Scrollable Body -->
        <div class="modal-body">
            <div id="customLegend" class="legend-grid"></div>
        </div>
    </div>
</div>

<script>
    // --- THEME TOGGLE LOGIC ---
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    let currentTheme = 'dark';

    themeToggle.addEventListener('click', () => {
        if (currentTheme === 'dark') {
            body.setAttribute('data-theme', 'light');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
            currentTheme = 'light';
        } else {
            body.setAttribute('data-theme', 'dark');
            themeIcon.classList.replace('fa-sun', 'fa-moon');
            currentTheme = 'dark';
        }
        // Force chart redraw to adapt colors
        const chartDiv = document.getElementById('mainChart');
        if(chartDiv.data) {
            Plotly.relayout(chartDiv, {
                'xaxis.gridcolor': currentTheme === 'dark' ? '#334155' : '#cbd5e1',
                'yaxis.gridcolor': currentTheme === 'dark' ? '#334155' : '#cbd5e1',
                'yaxis2.gridcolor': 'transparent' 
            });
        }
    });

    // --- HELPER: FORMAT DATE TO LOCAL STRING ---
    function formatDateToLocalString(date) {
        const pad = (num) => (num < 10 ? '0' : '') + num;
        return date.getFullYear() +
            '-' + pad(date.getMonth() + 1) +
            '-' + pad(date.getDate()) +
            ' ' + pad(date.getHours()) +
            ':' + pad(date.getMinutes()) +
            ':' + pad(date.getSeconds());
    }

    // --- NEW: ADVANCED DATE PARSER (FLEXIBLE) ---
    function parseDateSmart(str, formatHint) {
        if(!str) return null;
        // Clean cleanup: Remove quotes, double spaces
        const cleanStr = str.replace(/["']/g, '').trim().replace(/\s+/g, ' ');

        // Try standard ISO parsing first (YYYY-MM-DD or YYYY/MM/DD)
        // This usually works for standard DB outputs
        const isoTry = new Date(cleanStr);
        if (!isNaN(isoTry.getTime()) && cleanStr.match(/^\d{4}/)) {
            return isoTry;
        }

        // Split date and time
        // Separators: T, space
        const parts = cleanStr.split(/[\sT]+/);
        const datePart = parts[0];
        const timePart = parts[1] || "00:00:00";

        // Parse Time
        const tComps = timePart.split(':').map(Number);
        const hh = tComps[0] || 0;
        const mm = tComps[1] || 0;
        const ss = tComps[2] || 0;

        // Parse Date - Handle /, -, . separators
        const dComps = datePart.split(/[\/\-\.]/).map(Number);
        if (dComps.length < 3) return null; // Invalid date part

        let day, month, year;

        // Logic based on formatHint
        if (formatHint === 'ymd') {
            year = dComps[0];
            month = dComps[1];
            day = dComps[2];
        } else if (formatHint === 'mdy') {
            month = dComps[0];
            day = dComps[1];
            year = dComps[2];
        } else if (formatHint === 'dmy') {
            day = dComps[0];
            month = dComps[1];
            year = dComps[2];
        } else {
            // AUTO DETECTION LOGIC
            // Case 1: YYYY-MM-DD (Year is first and > 31)
            if (dComps[0] > 31) {
                year = dComps[0];
                month = dComps[1];
                day = dComps[2];
            } 
            // Case 2: Date ends with Year (DD-MM-YYYY or MM-DD-YYYY)
            else {
                // Try to infer Day vs Month
                const p1 = dComps[0];
                const p2 = dComps[1];
                const p3 = dComps[2];

                year = p3;
                
                // If 2nd part > 12, it MUST be Day => MM/DD/YYYY
                if (p2 > 12) {
                    month = p1;
                    day = p2;
                }
                // If 1st part > 12, it MUST be Day => DD/MM/YYYY
                else if (p1 > 12) {
                    day = p1;
                    month = p2;
                }
                // Ambiguous Case (e.g. 1/2/2024)
                // Default to DD/MM/YYYY (Common in TH/UK/EU)
                else {
                    day = p1;
                    month = p2;
                }
            }
        }

        // Year Correction (YY -> YYYY)
        if (year < 100) year += 2000;

        // Validate
        if (month < 1 || month > 12 || day < 1 || day > 31) return null;

        return new Date(year, month - 1, day, hh, mm, ss);
    }

    // --- PARSE CSV ---
    function parseCSV(data) {
        const lines = data.split('\n').filter(line => line.trim() !== "");
        if (lines.length === 0) return { time: [], datasets: {} };

        // Get User Preference
        const formatHint = document.getElementById('dateFormatSelect').value;

        // Delimiter Detection
        let tabCount = 0, commaCount = 0, semiCount = 0;
        const limit = Math.min(lines.length, 5);
        for(let i=0; i<limit; i++) {
            const line = lines[i];
            tabCount += (line.match(/\t/g) || []).length;
            commaCount += (line.match(/,/g) || []).length;
            semiCount += (line.match(/;/g) || []).length;
        }
        let splitter = ',';
        if (tabCount >= commaCount && tabCount >= semiCount && tabCount > 0) splitter = '\t';
        else if (semiCount > commaCount && semiCount > tabCount) splitter = ';';

        // Header Detection
        let unitRowIndex = -1;
        let nameRowIndex = -1;
        
        for (let i = 0; i < Math.min(lines.length, 15); i++) {
            const row = lines[i].split(splitter);
            const firstCell = row[0].replace(/["']/g, '').trim().toLowerCase();
            if (firstCell === 'unit') unitRowIndex = i;
            if (firstCell === 'name' || (firstCell === 'tag' && nameRowIndex === -1) || 
               ((firstCell === 'timestamp' || firstCell === 'date' || firstCell === 'time') && nameRowIndex === -1)) {
                nameRowIndex = i;
            }
        }
        
        let headers = [];
        let units = [];
        let dataStartIndex = 0;

        if (nameRowIndex === -1) {
            // Check if first row is data
            const firstRow = lines[0].split(splitter);
            const testDate = parseDateSmart(firstRow[0], formatHint);
            
            if (testDate && !isNaN(testDate.getTime())) {
                nameRowIndex = -1;
                dataStartIndex = 0;
                headers = ["Timestamp"];
                for(let j=1; j<firstRow.length; j++) headers.push(`Column ${j}`);
            } else {
                nameRowIndex = 0;
                dataStartIndex = 1;
            }
        } else {
            dataStartIndex = nameRowIndex + 1;
        }

        if (nameRowIndex !== -1) {
            const names = lines[nameRowIndex].trim().split(splitter).map(h => h.replace(/"/g, '').trim());
            if (unitRowIndex !== -1) units = lines[unitRowIndex].trim().split(splitter).map(u => u.replace(/"/g, '').trim());
            const headerCounts = {}; 
            headers = names.map((name, i) => {
                let label = name || `Col ${i}`;
                if (units[i] && units[i].toLowerCase() !== 'unit') label = `${label} (${units[i]})`;
                if (headerCounts[label]) { headerCounts[label]++; return `${label} (${headerCounts[label]})`; } 
                else { headerCounts[label] = 1; return label; }
            });
        }

        const result = { time: [], datasets: {} };
        for (let i = 1; i < headers.length; i++) if(headers[i]) result.datasets[headers[i]] = [];

        const dataRows = lines.slice(dataStartIndex);
        let lastBaseTimeStr = "";
        let secondOffset = 0;
        let validRows = 0;

        dataRows.forEach((rowStr) => {
            const cols = rowStr.split(splitter);
            if (cols.length < 1) return; 
            
            const baseTimeStr = cols[0].replace(/"/g, '').trim();
            if (!baseTimeStr) return;

            // Simple millisecond handler for duplicate timestamps
            if (baseTimeStr === lastBaseTimeStr) secondOffset += 1; // Increment just 1 sec/ms not 10
            else { secondOffset = 0; lastBaseTimeStr = baseTimeStr; }

            try {
                let dateObj = parseDateSmart(baseTimeStr, formatHint);
                
                if (dateObj) {
                    if (secondOffset > 0) dateObj.setSeconds(dateObj.getSeconds() + secondOffset);
                    result.time.push(formatDateToLocalString(dateObj));
                    validRows++;
                } else {
                    return; 
                }
            } catch (e) { return; }

            for (let i = 1; i < headers.length; i++) {
                const headerName = headers[i];
                if (!headerName) continue;
                let val = parseFloat(cols[i] ? cols[i].trim() : "");
                result.datasets[headerName].push(isNaN(val) ? null : val);
            }
        });
        
        console.log(`Parsed ${validRows} rows.`);
        return result;
    }

    // --- CHART RENDER ---
    function drawChart(parsedData) {
        if (!parsedData || parsedData.time.length === 0) {
            if(parsedData && document.getElementById('pasteInput').value.trim().length > 0) {
                 alert("Could not parse data. Check Date Format setting.");
            }
            return;
        }

        const traces = [];
        const colors = ['#00e676', '#4fc3f7', '#ff8a65', '#ba68c8', '#ffb74d', '#e57373', '#a1887f', '#90a4ae'];
        let colorIdx = 0;
        const legendItemsData = []; 

        if (parsedData && parsedData.datasets) {
            for (const [name, values] of Object.entries(parsedData.datasets)) {
                if (name.toLowerCase().includes('sequenceid')) continue;
                if (!values.some(v => v !== null)) continue;

                let yAxisID = 'y1'; 
                if (name.match(/degC|Â°C|degF|deg F|Temp|BPT|EXT/i)) yAxisID = 'y2'; 
                
                const traceColor = colors[colorIdx % colors.length];

                traces.push({
                    x: parsedData.time,
                    y: values,
                    mode: 'lines',
                    name: name,
                    yaxis: yAxisID,
                    line: { color: traceColor, width: 2.5, shape: 'spline', smoothing: 0.8 },
                    type: 'scatter',
                    connectgaps: true 
                });

                legendItemsData.push({ 
                    name: name, 
                    color: traceColor, 
                    index: traces.length - 1,
                    dash: 'solid'
                });
                colorIdx++;
            }
        }

        const layout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Inter, sans-serif', color: '#94a3b8', size: 12 },
            hovermode: 'closest', 
            hoverdistance: 30,    
            showlegend: false,    
            margin: { t: 80, b: 50, l: 60, r: 60 }, 
            xaxis: {
                gridcolor: currentTheme === 'dark' ? '#334155' : '#cbd5e1',
                showspikes: false, 
            },
            yaxis: {
                title: 'Main Units',
                gridcolor: currentTheme === 'dark' ? '#334155' : '#cbd5e1',
                zerolinecolor: currentTheme === 'dark' ? '#334155' : '#cbd5e1',
                showspikes: false,
            },
            yaxis2: {
                title: 'Temperature (Â°C)',
                overlaying: 'y',
                side: 'right',
                gridcolor: 'transparent',
                zeroline: false,
                showspikes: false,
            }
        };

        const config = { responsive: true, displayModeBar: false };
        const chartDiv = document.getElementById('mainChart');
        
        Plotly.newPlot('mainChart', traces, layout, config).then(() => {
            buildCustomLegend(legendItemsData, chartDiv);
            setupCustomHover(chartDiv, parsedData);
            setupClickInteraction(chartDiv, parsedData, traces);
        });
        
        document.getElementById('resetZoomBtn').onclick = function() {
            Plotly.relayout(chartDiv, { 'xaxis.autorange': true, 'yaxis.autorange': true, 'yaxis2.autorange': true });
        };

        document.getElementById('snapshotBtn').onclick = async function() {
            const flash = document.getElementById('snapshotFlash');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 200);

            await Plotly.downloadImage(chartDiv, {
                format: 'png',
                width: 1400, 
                height: 800, 
                filename: 'turbine-snapshot-' + new Date().toISOString().slice(0,19).replace(/:/g,'-')
            });
        };
    }

    // --- SIMPLIFIED HOVER ---
    const tooltip = document.getElementById('customTooltip');
    let hoverTimer;

    function setupCustomHover(chartDiv, parsedData) {
        Plotly.relayout(chartDiv, { 'hoverlabel.bgcolor': 'rgba(0,0,0,0)', 'hoverlabel.bordercolor': 'rgba(0,0,0,0)', 'hoverlabel.font.color': 'rgba(0,0,0,0)' });

        chartDiv.on('plotly_hover', function(data) {
            clearTimeout(hoverTimer);
            hoverTimer = setTimeout(() => {
                const pt = data.points[0];
                const timeStr = parsedData.time[pt.pointIndex];
                const color = pt.data.line.color;
                
                const html = `
                    <div class="tooltip-header-simple">${timeStr}</div>
                    <div class="tooltip-label-simple" style="color:${color}">
                        <span style="display:inline-block;width:10px;height:10px;background:${color};border-radius:50%;"></span>
                        ${pt.data.name}
                    </div>
                    <div class="tooltip-value-simple">${formatVal(pt.y)}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;">Click to view full data</div>
                `;

                tooltip.innerHTML = html;
                tooltip.classList.add('visible');
            }, 50);
        });

        chartDiv.addEventListener('mousemove', (e) => {
            const wrapper = document.querySelector('.chart-wrapper');
            const rect = wrapper.getBoundingClientRect();
            let x = e.clientX - rect.left + 15;
            let y = e.clientY - rect.top + 15;
            
            if (x + 160 > rect.width) x -= 180;
            if (y + 100 > rect.height) y -= 120;

            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        });

        chartDiv.on('plotly_unhover', function() {
            clearTimeout(hoverTimer);
            tooltip.classList.remove('visible');
        });
    }

    // --- CLICK TO SHOW SIDEBAR ---
    const inspector = document.getElementById('dataInspector');
    const inspectorContent = document.getElementById('inspectorContent');
    const inspectorTime = document.getElementById('inspectorTime');
    const closeInspectorBtn = document.getElementById('closeInspector');

    closeInspectorBtn.onclick = () => {
        inspector.classList.remove('active');
    };

    function setupClickInteraction(chartDiv, parsedData, traces) {
        chartDiv.on('plotly_click', function(data) {
            const pt = data.points[0];
            const idx = pt.pointIndex;
            const timeStr = parsedData.time[idx];

            inspectorTime.textContent = timeStr;
            inspectorContent.innerHTML = ''; 

            const visibleTraces = traces.filter((t, i) => {
                const meta = chartDiv._fullData[i]; 
                return meta.visible !== 'legendonly';
            });

            visibleTraces.forEach(trace => {
                const val = trace.y[idx];
                if (val !== null && val !== undefined) {
                    const row = document.createElement('div');
                    row.className = 'inspector-row';
                    row.style.setProperty('--row-color', trace.line.color);
                    row.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <span class="inspector-label">${trace.name}</span>
                        </div>
                        <span class="inspector-value">${formatVal(val)}</span>
                    `;
                    inspectorContent.appendChild(row);
                }
            });

            inspector.classList.add('active');
        });
    }

    function formatVal(v) { return typeof v === 'number' ? v.toFixed(2) : v; }

    // --- LEGEND LOGIC ---
    function buildCustomLegend(items, chartDiv) {
        const container = document.getElementById('customLegend');
        container.innerHTML = ''; 
        container.style.display = 'block'; 

        const elements = [];
        const groups = {};

        items.forEach(item => {
            const match = item.name.match(/^(.*?)\s*\(([^)]+)\)$/);
            let cleanName = item.name;
            let category = "General / No Unit";
            if (match) { cleanName = match[1].trim(); category = match[2].trim(); }
            if (!groups[category]) groups[category] = [];
            groups[category].push({ ...item, cleanName: cleanName });
        });

        const sortedCategories = Object.keys(groups).sort((a, b) => a.localeCompare(b));

        sortedCategories.forEach(category => {
            const groupItems = groups[category];
            groupItems.sort((a, b) => a.cleanName.localeCompare(b.cleanName));

            const groupBlock = document.createElement('div');
            groupBlock.className = 'legend-category-block';
            
            const header = document.createElement('div');
            header.className = 'legend-category-header';
            header.innerHTML = `<i class="fas fa-tag"></i> ${category}`;
            groupBlock.appendChild(header);

            const grid = document.createElement('div');
            grid.className = 'legend-grid'; 
            grid.style.padding = '0'; 
            
            groupItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'legend-card';
                card.dataset.name = item.cleanName.toLowerCase();

                const cardHeader = document.createElement('div');
                cardHeader.className = 'legend-card-header';
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'legend-card-info';
                
                const colorDot = document.createElement('div');
                colorDot.className = 'legend-color-dot';
                colorDot.style.background = item.color;

                const nameSpan = document.createElement('span');
                nameSpan.className = 'legend-name';
                nameSpan.innerText = item.cleanName;

                infoDiv.appendChild(colorDot);
                infoDiv.appendChild(nameSpan);

                const settingsBtn = document.createElement('i');
                settingsBtn.className = 'fas fa-cog legend-settings-btn';
                settingsBtn.title = 'Customize Line';

                cardHeader.appendChild(infoDiv);
                cardHeader.appendChild(settingsBtn);

                const settingsPanel = document.createElement('div');
                settingsPanel.className = 'legend-settings-panel';
                
                const colorRow = document.createElement('div');
                colorRow.className = 'setting-row';
                colorRow.innerHTML = `<span>Color</span>`;
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = item.color;
                colorRow.appendChild(colorInput);

                const styleRow = document.createElement('div');
                styleRow.className = 'setting-row';
                styleRow.innerHTML = `<span>Style</span>`;
                const styleSelect = document.createElement('select');
                styleSelect.className = 'style-select';
                ['solid', 'dash', 'dot', 'dashdot'].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.text = opt.charAt(0).toUpperCase() + opt.slice(1);
                    if(opt === 'solid') option.selected = true;
                    styleSelect.appendChild(option);
                });
                styleRow.appendChild(styleSelect);

                settingsPanel.appendChild(colorRow);
                settingsPanel.appendChild(styleRow);

                card.appendChild(cardHeader);
                card.appendChild(settingsPanel);

                cardHeader.onclick = (e) => {
                    if (e.target === settingsBtn || settingsPanel.contains(e.target)) return;
                    const isHidden = card.classList.contains('hidden-item');
                    if(isHidden) {
                        card.classList.remove('hidden-item');
                        colorDot.style.background = colorInput.value; 
                        Plotly.restyle(chartDiv, {visible: true}, [item.index]);
                    } else {
                        card.classList.add('hidden-item');
                        colorDot.style.background = '#777';
                        Plotly.restyle(chartDiv, {visible: 'legendonly'}, [item.index]);
                    }
                };

                settingsBtn.onclick = (e) => { e.stopPropagation(); settingsPanel.classList.toggle('open'); };
                colorInput.oninput = (e) => { e.stopPropagation(); const newColor = e.target.value; item.color = newColor; if(!card.classList.contains('hidden-item')) { colorDot.style.background = newColor; } Plotly.restyle(chartDiv, {'line.color': newColor}, [item.index]); };
                colorInput.onclick = (e) => e.stopPropagation();
                styleSelect.onchange = (e) => { e.stopPropagation(); const newDash = e.target.value; Plotly.restyle(chartDiv, {'line.dash': newDash}, [item.index]); };
                styleSelect.onclick = (e) => e.stopPropagation();

                grid.appendChild(card);
                elements.push({card, item, colorDot, colorInput});
            });
            groupBlock.appendChild(grid);
            container.appendChild(groupBlock);
        });

        // Search, Select All, Deselect All (Re-attach Logic)
        const searchInput = document.getElementById('legendSearch');
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        newSearchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            elements.forEach(obj => {
                const itemName = obj.card.dataset.name; 
                obj.card.style.display = itemName.includes(term) ? 'flex' : 'none';
            });
            document.querySelectorAll('.legend-category-block').forEach(block => {
                const visibleItems = Array.from(block.querySelectorAll('.legend-card')).filter(el => el.style.display !== 'none');
                block.style.display = visibleItems.length > 0 ? 'block' : 'none';
            });
        });

        const oldSelectBtn = document.getElementById('selectAllBtn');
        const newSelectBtn = oldSelectBtn.cloneNode(true);
        oldSelectBtn.parentNode.replaceChild(newSelectBtn, oldSelectBtn);
        newSelectBtn.onclick = () => {
            const indices = [];
            elements.forEach(obj => {
                obj.card.classList.remove('hidden-item');
                obj.colorDot.style.background = obj.item.color;
                indices.push(obj.item.index);
            });
            Plotly.restyle(chartDiv, {visible: true}, indices);
        };

        const oldDeselectBtn = document.getElementById('deselectAllBtn');
        const newDeselectBtn = oldDeselectBtn.cloneNode(true);
        oldDeselectBtn.parentNode.replaceChild(newDeselectBtn, oldDeselectBtn);
        newDeselectBtn.onclick = () => {
            const indices = [];
            elements.forEach(obj => {
                obj.card.classList.add('hidden-item');
                obj.colorDot.style.background = '#777';
                indices.push(obj.item.index);
            });
            Plotly.restyle(chartDiv, {visible: 'legendonly'}, indices);
        };
    }

    // --- UI/UX & DRAG ---
    const modal = document.getElementById('legendModal');
    document.getElementById('openLegendBtn').onclick = () => { modal.classList.add('show'); document.body.style.overflow = 'hidden'; }
    const closeModal = () => { modal.classList.remove('show'); document.body.style.overflow = ''; }
    document.querySelector('.close-modal').onclick = closeModal;
    window.onclick = (e) => { if (e.target == modal) closeModal(); }

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('csvInput');
    
    function handleFile(file) {
        if (!file) return;
        document.getElementById('loader').style.display = 'block';
        document.getElementById('mainChart').style.opacity = '0.3';
        setTimeout(() => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const parsed = parseCSV(event.target.result);
                document.getElementById('fileName').textContent = `File: ${file.name}`;
                document.getElementById('fileInfo').classList.add('visible');
                drawChart(parsed);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('mainChart').style.opacity = '1';
            };
            reader.readAsText(file);
        }, 100);
    }

    document.getElementById('processPasteBtn').onclick = () => {
        const txt = document.getElementById('pasteInput').value;
        if(!txt.trim()) return;
        const parsed = parseCSV(txt);
        document.getElementById('fileName').textContent = "Source: Pasted Data";
        document.getElementById('fileInfo').classList.add('visible');
        drawChart(parsed);
    };

    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

    function makeDraggable(elmnt) {
      var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      const header = elmnt.querySelector(".inspector-header");
      if (header) header.onmousedown = dragMouseDown;
      function dragMouseDown(e) {
        if(e.target.closest('.close-inspector')) return;
        e = e || window.event; e.preventDefault();
        pos3 = e.clientX; pos4 = e.clientY;
        document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
      }
      function elementDrag(e) {
        e = e || window.event; e.preventDefault();
        pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
        pos3 = e.clientX; pos4 = e.clientY;
        if(elmnt.style.right && elmnt.style.right !== 'auto') {
            const rect = elmnt.getBoundingClientRect();
            const parentRect = elmnt.offsetParent ? elmnt.offsetParent.getBoundingClientRect() : document.body.getBoundingClientRect();
            elmnt.style.left = (rect.left - parentRect.left) + "px";
            elmnt.style.right = 'auto'; 
        } else if (!elmnt.style.left) {
            const rect = elmnt.getBoundingClientRect();
            const parentRect = elmnt.offsetParent ? elmnt.offsetParent.getBoundingClientRect() : document.body.getBoundingClientRect();
            elmnt.style.left = (rect.left - parentRect.left) + "px";
            elmnt.style.right = 'auto';
        }
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
      }
      function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }

    makeDraggable(document.getElementById("dataInspector"));
    drawChart({ time: [], datasets: {} });
</script>
</body>
</html>
